// This is your Prisma schema file
// Learn more: https://pris.ly/d/prisma-schema

generator client {
  provider        = "prisma-client"
  output          = "../src/generated/prisma"
  previewFeatures = ["postgresqlExtensions"]
}

datasource db {
  provider = "postgresql"
  // Note: url is now configured in prisma.config.ts for Prisma 7+
  // See docs/deployment/upgrade-to-timescaledb.md for production upgrade guide
}

// ===== 資金費率記錄 (TimescaleDB Hypertable) =====
model FundingRate {
  id                String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  exchange          String    @db.VarChar(50)
  symbol            String    @db.VarChar(20)
  funding_rate      Decimal   @db.Decimal(10, 8)
  next_funding_time DateTime  @db.Timestamptz
  mark_price        Decimal?  @db.Decimal(20, 8)
  index_price       Decimal?  @db.Decimal(20, 8)
  recorded_at       DateTime  @default(now()) @db.Timestamptz // 分區鍵
  created_at        DateTime  @default(now()) @db.Timestamptz

  @@unique([exchange, symbol, recorded_at])
  @@index([recorded_at(sort: Desc)])
  @@index([exchange, symbol, recorded_at(sort: Desc)])
  @@index([symbol, recorded_at(sort: Desc)])
  @@map("funding_rates")
}

// ===== 風險參數 =====
model RiskParameters {
  id                       String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  name                     String   @unique @db.VarChar(100)
  description              String?  @db.Text
  min_rate_difference      Decimal  @default(0.0005) @db.Decimal(10, 8)
  max_position_size_usdt   Decimal  @default(10000) @db.Decimal(20, 8)
  max_total_exposure_usdt  Decimal  @default(50000) @db.Decimal(20, 8)
  max_leverage             Int      @default(5)
  stop_loss_rate           Decimal  @default(0.001) @db.Decimal(10, 8)
  max_holding_hours        Int      @default(24)
  position_size_percentage Decimal  @default(0.03) @db.Decimal(10, 8)
  enable_auto_trading      Boolean  @default(false)
  enable_auto_close        Boolean  @default(true)
  max_slippage_rate        Decimal  @default(0.001) @db.Decimal(10, 8)
  min_liquidity_usdt       Decimal  @default(50000) @db.Decimal(20, 8)
  is_active                Boolean  @default(true)
  created_at               DateTime @default(now()) @db.Timestamptz
  updated_at               DateTime @updatedAt @db.Timestamptz

  @@index([is_active], map: "idx_risk_params_active")
  @@map("risk_parameters")
}

// ===== 資金費率驗證記錄 (TimescaleDB Hypertable) =====
model FundingRateValidation {
  id                  Int      @id @default(autoincrement())
  timestamp           DateTime @default(now()) @db.Timestamptz(6)
  symbol              String   @db.VarChar(20)
  exchange            String   @default("okx") @db.VarChar(50)
  okxRate             Decimal  @db.Decimal(18, 8)
  okxNextRate         Decimal? @db.Decimal(18, 8)
  okxFundingTime      DateTime? @db.Timestamptz(6)
  ccxtRate            Decimal? @db.Decimal(18, 8)
  ccxtFundingTime     DateTime? @db.Timestamptz(6)
  discrepancyPercent  Decimal? @db.Decimal(10, 6)
  validationStatus    String   @db.VarChar(10)
  errorMessage        String?  @db.Text

  @@unique([timestamp, symbol])
  @@index([symbol, timestamp(sort: Desc)])
  @@index([validationStatus, timestamp(sort: Desc)])
  @@index([timestamp(sort: Desc)])
  @@map("funding_rate_validations")
}

// ===== 系統事件 (TimescaleDB Hypertable) =====
model SystemEvent {
  id          String        @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  event_type  String        @db.VarChar(50)
  severity    EventSeverity
  exchange    String?       @db.VarChar(50)
  symbol      String?       @db.VarChar(20)
  message     String        @db.Text
  details     Json?         @db.JsonB
  related_id  String?       @db.Uuid
  is_notified Boolean       @default(false)
  occurred_at DateTime      @default(now()) @db.Timestamptz
  created_at  DateTime      @default(now()) @db.Timestamptz

  @@index([event_type, occurred_at(sort: Desc)], map: "idx_event_type_occurred")
  @@index([severity, occurred_at(sort: Desc)], map: "idx_event_severity")
  @@index([is_notified], map: "idx_event_notified")
  @@map("system_events")
}

enum EventSeverity {
  INFO     // 資訊
  WARNING  // 警告
  ERROR    // 錯誤
  CRITICAL // 嚴重

  @@map("event_severity")
}

// ===== Web 多用戶平台模型 (Feature 006) =====

// ===== 用戶角色 (Feature 068) =====
enum UserRole {
  USER   // 一般用戶
  ADMIN  // 管理員

  @@map("user_role")
}

// ===== 用戶 =====
model User {
  id        String   @id @default(cuid())
  email     String   @unique @db.VarChar(255)
  password  String   @db.VarChar(255) // bcrypt hashed
  createdAt DateTime @default(now()) @db.Timestamptz
  updatedAt DateTime @updatedAt @db.Timestamptz

  // ===== 用戶角色與狀態 (Feature 068) =====
  role     UserRole @default(USER)      // 用戶角色
  isActive Boolean  @default(true)      // 帳戶啟用狀態

  // 用戶偏好設定
  timeBasisPreference Int @default(8) // 時間基準偏好: 1, 4, 8, 24 小時

  // ===== 密碼管理 (Feature 061) =====
  tokenVersion        Int       @default(0)                // JWT 版本號，密碼變更時遞增
  failedLoginAttempts Int       @default(0)                // 連續登入失敗次數
  lockedUntil         DateTime? @db.Timestamptz            // 帳戶鎖定截止時間
  passwordChangedAt   DateTime? @db.Timestamptz            // 最後密碼變更時間

  // Relations
  apiKeys                 ApiKey[]
  positions               Position[]
  trades                  Trade[]
  auditLogs               AuditLog[]
  notificationWebhooks    NotificationWebhook[]
  opportunityEndHistories OpportunityEndHistory[]
  simulatedTrackings      SimulatedTracking[]
  assetSnapshots          AssetSnapshot[]
  tradingSettings         TradingSettings?
  passwordResetTokens     PasswordResetToken[]             // Feature 061

  @@index([email])
  @@index([isActive])  // Feature 068: 用於篩選啟用/停用用戶列表
  @@map("users")
}

// ===== 密碼重設 Token (Feature 061) =====
model PasswordResetToken {
  id        String    @id @default(cuid())
  userId    String
  tokenHash String    @db.VarChar(255)              // bcrypt hashed token
  expiresAt DateTime  @db.Timestamptz               // 過期時間（建立後 1 小時）
  usedAt    DateTime? @db.Timestamptz               // 使用時間（null = 未使用）
  ipAddress String?   @db.VarChar(45)               // 請求 IP
  createdAt DateTime  @default(now()) @db.Timestamptz

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, createdAt(sort: Desc)])
  @@index([expiresAt])
  @@map("password_reset_tokens")
}

// ===== API Key 管理 =====
model ApiKey {
  id                  String         @id @default(cuid())
  userId              String
  exchange            String         @db.VarChar(50) // "binance" | "okx"
  environment         ApiEnvironment @default(MAINNET) // 環境：主網或測試網
  label               String         @db.VarChar(100)
  encryptedKey        String         @db.Text // AES-256-GCM encrypted
  encryptedSecret     String         @db.Text
  encryptedPassphrase String?        @db.Text // OKX only
  portfolioMargin     Boolean        @default(false) // Binance 統一帳戶模式
  isActive            Boolean        @default(true)
  lastValidatedAt     DateTime?      @db.Timestamptz
  createdAt           DateTime       @default(now()) @db.Timestamptz
  updatedAt           DateTime       @updatedAt @db.Timestamptz

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, exchange, label])
  @@index([userId, isActive])
  @@index([exchange])
  @@map("api_keys")
}

enum ApiEnvironment {
  MAINNET // 主網（真實交易）
  TESTNET // 測試網（Binance Testnet / OKX Demo Trading）
}

// ===== 持倉管理 =====
model Position {
  id                   String           @id @default(cuid())
  userId               String
  symbol               String           @db.VarChar(20)
  longExchange         String           @db.VarChar(50)
  longOrderId          String?          @db.VarChar(100)
  longEntryPrice       Decimal          @db.Decimal(18, 8)
  longPositionSize     Decimal          @db.Decimal(18, 8)
  longLeverage         Int              @default(3)
  longExitPrice        Decimal?         @db.Decimal(18, 8) // Feature: 035-close-position
  longCloseOrderId     String?          @db.VarChar(100)   // Feature: 035-close-position
  shortExchange        String           @db.VarChar(50)
  shortOrderId         String?          @db.VarChar(100)
  shortEntryPrice      Decimal          @db.Decimal(18, 8)
  shortPositionSize    Decimal          @db.Decimal(18, 8)
  shortLeverage        Int              @default(3)
  shortExitPrice       Decimal?         @db.Decimal(18, 8) // Feature: 035-close-position
  shortCloseOrderId    String?          @db.VarChar(100)   // Feature: 035-close-position
  status               PositionWebStatus @default(PENDING)
  openFundingRateLong  Decimal          @db.Decimal(10, 8)
  openFundingRateShort Decimal          @db.Decimal(10, 8)
  unrealizedPnL        Decimal?         @db.Decimal(18, 8)
  openedAt             DateTime?        @db.Timestamptz
  closedAt             DateTime?        @db.Timestamptz
  failureReason        String?          @db.Text
  createdAt            DateTime         @default(now()) @db.Timestamptz
  updatedAt            DateTime         @updatedAt @db.Timestamptz

  // ===== 停損設定 (Feature 038) =====
  stopLossEnabled       Boolean   @default(false)
  stopLossPercent       Decimal?  @db.Decimal(5, 2)  // 0.50 - 50.00
  longStopLossPrice     Decimal?  @db.Decimal(20, 8)
  longStopLossOrderId   String?   @db.VarChar(100)
  shortStopLossPrice    Decimal?  @db.Decimal(20, 8)
  shortStopLossOrderId  String?   @db.VarChar(100)

  // ===== 停利設定 (Feature 038) =====
  takeProfitEnabled       Boolean   @default(false)
  takeProfitPercent       Decimal?  @db.Decimal(5, 2)  // 0.50 - 100.00
  longTakeProfitPrice     Decimal?  @db.Decimal(20, 8)
  longTakeProfitOrderId   String?   @db.VarChar(100)
  shortTakeProfitPrice    Decimal?  @db.Decimal(20, 8)
  shortTakeProfitOrderId  String?   @db.VarChar(100)

  // ===== 條件單設定狀態 (Feature 038) =====
  conditionalOrderStatus  ConditionalOrderStatus @default(PENDING)
  conditionalOrderError   String?                @db.Text

  // ===== 平倉原因 (Feature 050) =====
  closeReason             CloseReason?

  // ===== 平倉建議 (Feature 067) =====
  cachedFundingPnL            Decimal?  @db.Decimal(18, 8)
  cachedFundingPnLUpdatedAt   DateTime? @db.Timestamptz
  exitSuggested               Boolean   @default(false)
  exitSuggestedAt             DateTime? @db.Timestamptz
  exitSuggestedReason         String?   @db.VarChar(50)

  // ===== 分單開倉組別 (Feature 069, 070) =====
  groupId                     String    @db.Uuid @default(dbgenerated("gen_random_uuid()"))  // 持倉組別 ID（所有持倉必須有 groupId）

  // Relations
  user  User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  trade Trade?

  @@index([userId, status])
  @@index([symbol, status])
  @@index([createdAt(sort: Desc)])
  @@index([groupId])  // Feature 069: 加速組別查詢
  @@map("positions")
}

enum PositionWebStatus {
  PENDING // 待開倉
  OPENING // 開倉中
  OPEN    // 持倉中
  CLOSING // 平倉中
  CLOSED  // 已平倉
  FAILED  // 失敗
  PARTIAL // 部分成功

  @@map("position_web_status")
}

// ===== 條件單狀態 (Feature 038) =====
enum ConditionalOrderStatus {
  PENDING  // 尚未設定
  SETTING  // 設定中
  SET      // 設定成功
  PARTIAL  // 部分成功
  FAILED   // 設定失敗

  @@map("conditional_order_status")
}

// ===== 平倉原因 (Feature 050, 053, 069) =====
enum CloseReason {
  MANUAL              // 手動平倉
  LONG_SL_TRIGGERED   // 多方停損觸發
  LONG_TP_TRIGGERED   // 多方停利觸發
  SHORT_SL_TRIGGERED  // 空方停損觸發
  SHORT_TP_TRIGGERED  // 空方停利觸發
  BOTH_TRIGGERED      // 雙邊同時觸發
  UNCONFIRMED_TRIGGER // 無法確認觸發狀態，預防性平倉 (Feature 053)
  BATCH_CLOSE         // 批量平倉 (Feature 069)

  @@map("close_reason")
}

// ===== 交易記錄 =====
model Trade {
  id                  String       @id @default(cuid())
  userId              String
  positionId          String       @unique
  symbol              String       @db.VarChar(20)
  longExchange        String       @db.VarChar(50)
  longEntryPrice      Decimal      @db.Decimal(18, 8)
  longExitPrice       Decimal      @db.Decimal(18, 8)
  longPositionSize    Decimal      @db.Decimal(18, 8)
  longFee             Decimal      @default(0) @db.Decimal(18, 8) // Feature: 035-close-position
  shortExchange       String       @db.VarChar(50)
  shortEntryPrice     Decimal      @db.Decimal(18, 8)
  shortExitPrice      Decimal      @db.Decimal(18, 8)
  shortPositionSize   Decimal      @db.Decimal(18, 8)
  shortFee            Decimal      @default(0) @db.Decimal(18, 8) // Feature: 035-close-position
  openedAt            DateTime     @db.Timestamptz
  closedAt            DateTime     @db.Timestamptz
  holdingDuration     Int          // seconds
  priceDiffPnL        Decimal      @db.Decimal(18, 8)
  fundingRatePnL      Decimal      @db.Decimal(18, 8)
  totalFees           Decimal      @default(0) @db.Decimal(18, 8) // Feature: 035-close-position
  totalPnL            Decimal      @db.Decimal(18, 8)
  roi                 Decimal      @db.Decimal(10, 4)
  status              TradeWebStatus @default(SUCCESS)
  createdAt           DateTime     @default(now()) @db.Timestamptz

  // Relations
  user     User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  position Position @relation(fields: [positionId], references: [id], onDelete: Restrict)

  @@index([userId, createdAt(sort: Desc)])
  @@index([symbol, createdAt(sort: Desc)])
  @@index([createdAt(sort: Desc)])
  @@map("trades")
}

enum TradeWebStatus {
  SUCCESS // 完全成功
  PARTIAL // 部分成功
  FAILED  // 失敗

  @@map("trade_web_status")
}

// ===== 審計日誌 =====
model AuditLog {
  id        String   @id @default(cuid())
  userId    String?
  action    String   @db.VarChar(50) // "LOGIN" | "APIKEY_ADD" | "POSITION_OPEN" | etc.
  resource  String?  @db.VarChar(100)
  details   Json?    @db.JsonB
  ipAddress String?  @db.VarChar(45)
  createdAt DateTime @default(now()) @db.Timestamptz

  // Relations
  user User? @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@index([userId, createdAt(sort: Desc)])
  @@index([action, createdAt(sort: Desc)])
  @@index([createdAt(sort: Desc)])
  @@map("audit_logs")
}

// ===== 通知 Webhook 設定 (Feature 026) =====
model NotificationWebhook {
  id                String   @id @default(cuid())
  userId            String
  platform          String   @db.VarChar(20)  // 'discord' | 'slack'
  webhookUrl        String   @db.Text         // AES-256-GCM 加密儲存
  name              String   @db.VarChar(100) // 用戶自訂名稱
  isEnabled         Boolean  @default(true)
  threshold           Decimal  @default(800) @db.Decimal(10, 4) // 年化收益閾值 %
  notifyOnDisappear   Boolean  @default(true)   // Feature 027: 是否接收機會結束通知
  notificationMinutes Int[]    @default([50])   // 通知時間（每小時的第幾分鐘），最多 2 個
  requireFavorablePrice Boolean @default(false)  // Feature 057: 是否啟用價差過濾（淨收益 > 0 且價差方向正確時才通知）
  createdAt           DateTime @default(now()) @db.Timestamptz
  updatedAt         DateTime @updatedAt @db.Timestamptz

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, isEnabled])
  @@index([platform])
  @@map("notification_webhooks")
}

// ===== 套利機會歷史記錄 (Feature 027) =====
model OpportunityEndHistory {
  id                   String   @id @default(cuid())

  // 基本資訊
  symbol               String   @db.VarChar(20)
  longExchange         String   @db.VarChar(20)
  shortExchange        String   @db.VarChar(20)

  // 時間資訊
  detectedAt           DateTime @db.Timestamptz
  disappearedAt        DateTime @db.Timestamptz
  durationMs           BigInt

  // 費差統計
  initialSpread        Decimal  @db.Decimal(10, 6)
  maxSpread            Decimal  @db.Decimal(10, 6)
  maxSpreadAt          DateTime @db.Timestamptz
  finalSpread          Decimal  @db.Decimal(10, 6)

  // 費率結算週期
  longIntervalHours    Int      @db.SmallInt
  shortIntervalHours   Int      @db.SmallInt

  // 費率結算記錄 (JSON)
  settlementRecords    Json     @default("[]") @db.JsonB
  // 格式: [{ side: "long"|"short", timestamp: ISO8601, rate: number }]

  // 模擬收益計算結果
  longSettlementCount  Int      @db.SmallInt
  shortSettlementCount Int      @db.SmallInt
  totalFundingProfit   Decimal  @db.Decimal(10, 6)
  totalCost            Decimal  @db.Decimal(10, 6) // 固定 0.002 (0.2%)
  netProfit            Decimal  @db.Decimal(10, 6)
  realizedAPY          Decimal  @db.Decimal(10, 2)

  // 通知統計
  notificationCount    Int      @default(1)

  // 關聯用戶
  userId               String
  user                 User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  createdAt            DateTime @default(now()) @db.Timestamptz

  @@index([userId])
  @@index([symbol])
  @@index([disappearedAt(sort: Desc)])
  @@map("opportunity_end_histories")
}

// ===== 模擬套利追蹤 (Feature 029) =====
model SimulatedTracking {
  id                String   @id @default(cuid())
  userId            String

  // 套利機會識別
  symbol            String   @db.VarChar(20)
  longExchange      String   @db.VarChar(20)
  shortExchange     String   @db.VarChar(20)

  // 模擬設定
  simulatedCapital  Decimal  @db.Decimal(18, 8)
  autoStopOnExpire  Boolean  @default(true)

  // 開始追蹤時的狀態快照
  initialSpread     Decimal  @db.Decimal(10, 6)
  initialAPY        Decimal  @db.Decimal(10, 2)
  initialLongRate   Decimal  @db.Decimal(10, 8)
  initialShortRate  Decimal  @db.Decimal(10, 8)

  // 開倉價格和倉位數量（固定顆數模式）
  initialLongPrice  Decimal? @db.Decimal(18, 8)  // 做多交易所開倉價格
  initialShortPrice Decimal? @db.Decimal(18, 8)  // 做空交易所開倉價格
  positionQuantity  Decimal? @db.Decimal(18, 8)  // 固定倉位數量（顆數）

  // 平倉價格和損益（停止追蹤時記錄）
  exitLongPrice     Decimal? @db.Decimal(18, 8)  // 做多交易所平倉價格
  exitShortPrice    Decimal? @db.Decimal(18, 8)  // 做空交易所平倉價格
  pricePnl          Decimal? @db.Decimal(18, 8)  // 幣價損益
  fundingPnl        Decimal? @db.Decimal(18, 8)  // 資費差損益（= totalFundingProfit）
  tradingCost       Decimal? @db.Decimal(18, 8)  // 交易成本（開平倉手續費）
  totalPnl          Decimal? @db.Decimal(18, 8)  // 合計損益（已扣除交易成本）

  // 交易所結算週期
  longIntervalHours    Int   @db.SmallInt
  shortIntervalHours   Int   @db.SmallInt

  // 追蹤狀態
  status            TrackingStatus @default(ACTIVE)

  // 時間資訊
  startedAt         DateTime @default(now()) @db.Timestamptz
  stoppedAt         DateTime? @db.Timestamptz

  // 累計統計（每次快照後更新）
  totalFundingProfit   Decimal  @default(0) @db.Decimal(18, 8)
  totalSettlements     Int      @default(0)
  maxSpread            Decimal  @default(0) @db.Decimal(10, 6)
  minSpread            Decimal  @default(0) @db.Decimal(10, 6)

  createdAt         DateTime @default(now()) @db.Timestamptz
  updatedAt         DateTime @updatedAt @db.Timestamptz

  // Relations
  user              User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  snapshots         TrackingSnapshot[]

  // Constraints
  @@unique([userId, symbol, longExchange, shortExchange, status])
  @@index([userId, status])
  @@index([symbol])
  @@index([startedAt(sort: Desc)])
  @@map("simulated_trackings")
}

enum TrackingStatus {
  ACTIVE
  STOPPED
  EXPIRED
}

model TrackingSnapshot {
  id                String   @id @default(cuid())
  trackingId        String

  // 快照類型
  snapshotType      SnapshotType

  // 費率數據
  longRate          Decimal  @db.Decimal(10, 8)
  shortRate         Decimal  @db.Decimal(10, 8)
  spread            Decimal  @db.Decimal(10, 6)
  annualizedReturn  Decimal  @db.Decimal(10, 2)

  // 價格數據（選填）
  longPrice         Decimal? @db.Decimal(18, 8)
  shortPrice        Decimal? @db.Decimal(18, 8)
  priceDiffPercent  Decimal? @db.Decimal(10, 4)

  // 結算時特有欄位
  settlementSide    SettlementSide?
  fundingProfit     Decimal? @db.Decimal(18, 8)
  cumulativeProfit  Decimal  @db.Decimal(18, 8)

  recordedAt        DateTime @default(now()) @db.Timestamptz

  // Relations
  tracking          SimulatedTracking @relation(fields: [trackingId], references: [id], onDelete: Cascade)

  // Indexes
  @@index([trackingId, recordedAt(sort: Desc)])
  @@index([trackingId, snapshotType])
  @@map("tracking_snapshots")
}

enum SnapshotType {
  SETTLEMENT
  PERIODIC
}

enum SettlementSide {
  LONG
  SHORT
  BOTH
}

// ===== 資產快照 (Feature 031) =====
model AssetSnapshot {
  id                String   @id @default(cuid())
  userId            String

  // 各交易所餘額（USD）- 可為 null 表示該交易所未設定 API Key 或查詢失敗
  binanceBalanceUSD Decimal? @db.Decimal(18, 8)
  okxBalanceUSD     Decimal? @db.Decimal(18, 8)
  mexcBalanceUSD    Decimal? @db.Decimal(18, 8)
  gateioBalanceUSD  Decimal? @db.Decimal(18, 8)
  bingxBalanceUSD   Decimal? @db.Decimal(18, 8) // Feature 043: BingX 整合

  // 總資產（已設定交易所的加總）
  totalBalanceUSD   Decimal  @db.Decimal(18, 8)

  // 各交易所連線狀態
  binanceStatus     String?  @db.VarChar(50) // 'success' | 'no_api_key' | 'api_error' | 'rate_limited'
  okxStatus         String?  @db.VarChar(50)
  mexcStatus        String?  @db.VarChar(50)
  gateioStatus      String?  @db.VarChar(50)
  bingxStatus       String?  @db.VarChar(50) // Feature 043: BingX 整合

  // 時間資訊
  recordedAt        DateTime @db.Timestamptz
  createdAt         DateTime @default(now()) @db.Timestamptz

  // Relations
  user              User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, recordedAt(sort: Desc)])
  @@index([recordedAt(sort: Desc)])
  @@map("asset_snapshots")
}

// ===== 交易設定 (Feature 038) =====
model TradingSettings {
  id                        String   @id @default(cuid())
  userId                    String   @unique
  user                      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  // 停損預設值
  defaultStopLossEnabled    Boolean  @default(true)
  defaultStopLossPercent    Decimal  @default(5.00) @db.Decimal(5, 2)

  // 停利預設值
  defaultTakeProfitEnabled  Boolean  @default(false)
  defaultTakeProfitPercent  Decimal  @default(3.00) @db.Decimal(5, 2)

  // 其他交易設定
  defaultLeverage           Int      @default(1)
  maxPositionSizeUSD        Decimal  @default(10000) @db.Decimal(20, 2)

  // ===== 平倉建議設定 (Feature 067) =====
  exitSuggestionEnabled     Boolean  @default(true)
  exitSuggestionThreshold   Decimal  @default(100) @db.Decimal(10, 2)
  exitNotificationEnabled   Boolean  @default(true)

  createdAt                 DateTime @default(now()) @db.Timestamptz
  updatedAt                 DateTime @updatedAt @db.Timestamptz

  @@map("trading_settings")
}

// ===== 套利機會即時追蹤 (Feature 065) =====
model ArbitrageOpportunity {
  id                String            @id @default(cuid())

  // 識別資訊
  symbol            String            @db.VarChar(20)
  longExchange      String            @db.VarChar(20)
  shortExchange     String            @db.VarChar(20)

  // 狀態
  status            OpportunityStatus @default(ACTIVE)

  // 時間資訊
  detectedAt        DateTime          @default(now()) @db.Timestamptz
  endedAt           DateTime?         @db.Timestamptz
  durationMs        BigInt?

  // 費差統計
  initialSpread     Decimal           @db.Decimal(10, 6)
  maxSpread         Decimal           @db.Decimal(10, 6)
  maxSpreadAt       DateTime          @db.Timestamptz
  currentSpread     Decimal           @db.Decimal(10, 6)

  // 年化報酬
  initialAPY        Decimal           @db.Decimal(10, 2)
  maxAPY            Decimal           @db.Decimal(10, 2)
  currentAPY        Decimal           @db.Decimal(10, 2)

  // 費率結算週期
  longIntervalHours   Int             @db.SmallInt
  shortIntervalHours  Int             @db.SmallInt

  createdAt         DateTime          @default(now()) @db.Timestamptz
  updatedAt         DateTime          @updatedAt @db.Timestamptz

  @@unique([symbol, longExchange, shortExchange, status])
  @@index([status])
  @@index([detectedAt(sort: Desc)])
  @@index([endedAt(sort: Desc)])
  @@map("arbitrage_opportunities")
}

enum OpportunityStatus {
  ACTIVE  // 進行中
  ENDED   // 已結束

  @@map("opportunity_status")
}
